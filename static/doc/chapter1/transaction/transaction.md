#### 1.3 事务

事务就是一组原子性的SQL查询,或者说一个独立的工作单元。
如果数据库引擎能够成功地对数据库应用该组查询的全部语句，
那么久执行该组查询。
如果其中有任何一条语句因为奔溃或者其他原因无法执行，
那么所有的语句都不会执行。
也就是说，事务内的语句，
要么全部执行成功，要么全部执行失败。

银行应用是解释事务必要性的一个经典例子。
假设一个银行的数据库有俩张表：支票(checking)表和存储(saving)表。
现在要从用户Jane的支票账户转移200美元到她的储蓄账户，
那么至少需要三个步骤：

1. 检查支票账户的余额高于200美元。
2. 从支票账户余额中减去200美元。
3. 在储蓄账户余额中增加200美元。

上述三个步骤的操作必须打包在一个事务中，
任何一个步骤失败，则必须回滚所有的步骤。


可以用START TRANSACTION语句开始一个事务，
然后要么使用COMMIT提交事务将修改的数据持久保留，
要么使用ROLLBACK撤销所有的修改。
事务SQL的样本如下：

```mysql
START TRANSACTION;
SELECT balance FROM checking WHERE customer_id = 10233276;
UPDATE checking SET balance = balance-200.00 WHERE customer_id = 10233276;
UPDATE savings SET balance = balance+200.00 WHERE customer_id = 10233276;
COMMIT;
```

单纯的事务概念并不是故事的全部。
试想一下，如果执行到第四条语句时服务器奔溃了，
用户可能会损失200美元。
再假如，在执行到第三条语句和第四条语句之间时，
另外一个进程要删除支票账户的所有余额，
那么结果可能就是银行在不知道这个逻辑的情况下白白给了Jane200美元。


除非系统通过严格的ACID测试，否则空谈事务的概念是不够的。
ACID表示原子性(atomicity)、一致性(consistency)、隔离性(isolation)和持久性(durability)。
一个运行良好的事务处理系统，必须具备这么标准特征。

> 原子性 (atomicity)

    一个事务必须被视为一个不可分割的最小工作单元，
    整个事务中的所有操作要么全部提交成功，要么全部失败回滚，
    对于一个事务来说，不可能只执行其中的一部分操作，
    这就是事务的原子性。
    
> 一致性 (consistency)

    数据库总是从一个一致性的状态转换到另外一个一致性的状态。
    在前面的例子中，一致性确保了，
    即时在执行第三、四条语句之间时系统奔溃，支票账户中也不会损失200美元，
    因为事务最终没有提交，所以事务中所做的修改也不会保存到数据库中。
    
> 隔离性 (isolation)

    通常来说，一个事务所做的修改在最终提交以前，
    对其他事务是不可见的。
    在前面的例子中，当执行完第三条语句、第四条语句还未开始时，
    此时有另外一个账户汇总程序开始运行，
    则其看到的支票账户的余额并没有被减去200美元。
    后面我们讨论隔离级别(isolation level)的时候，
    会发现为什么我们要说“通常来说”是不可见的。
    
> 持久性 (durability)

    一旦事务提交，则其所做的修改就会永久保存到数据库中。
    此时即使系统奔溃，修改的数据也不会丢失。
    持久性是个有点模糊的概念，因为实际上持久性也分很多中不同的级别。
    有些持久性策略能够提供非常强的安全保障，而有些则未必。
    而且不可能有能做到100%的持久性保证的策略。
    
    
事务的ACID特性可以确保银行不会弄丢你的钱。
而在应用逻辑中，要实现这一点非常难，
甚至可以说是不可能完成的任务。
一个兼容ACID的数据库系统，需要做很多复杂但可能用户并没有觉察到的工作，
才能确保ACID的实现。


就像锁粒度的升级会增加系统开销一样，这种事务处理过程中额外的安全性，
也会需要数据库系统做更多额外工作。
一个实现ACID的数据库，相比没有实现ACID的数据库，
通常会需要更强的CPU处理能力、更大的内存和更多的磁盘空间。
正如本章不断重复的，这也正是MySQL的存储引擎架构可以发挥优势的地方。
用户可以根据业务是否需要事务处理，来选择合适的存储引擎。
对于一些不要事务的查询类应用，选择一个非事务型的存储引擎，可以获得更高的性能。
即使存储引擎不支持事务，也可以通过 **LOCK TABLES**语句为应用提供一定程度地保护，
这些选择用户都可以自主决定。



    
    
    
    
    
    
    
    
    
    
    
    
    
    
    















